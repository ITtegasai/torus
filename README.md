# Torus Project

Этот репозиторий содержит набор микросервисов и клиентские приложения для проекта Torus. Все сервисы используют Python и FastAPI, база данных разворачивается в контейнерах PostgreSQL.

## Структура репозитория

- **auth/** – сервис аутентификации пользователей.
- **messages/** – сервис отправки email‑сообщений (коды подтверждения и уведомления).
- **main/** – основной бизнес‑логика сервиса и WebSocket API.
- **db/** – конфигурации и скрипты для кластера PostgreSQL.
- **frontend/** – клиентские приложения (user и admin).
- **run_all.csh** – запуск всех сервисов в режиме разработки.
- **update_service.csh** – обновление отдельного сервиса и перезапуск.

## Быстрый старт

1. Развернуть базу данных:

```bash
cd db
./run_db.csh
```

Скрипт останавливает предыдущие контейнеры и запускает `docker compose` для двух реплик БД, а также экспортёры метрик Prometheus.

2. Для запуска всех сервисов и фронтенда используйте скрипт из корня репозитория:

```bash
./run_all.csh
```

Скрипт создаёт несколько `screen`‑сессий и поднимает сервисы на портах 8000, 8015 и 8001, а также фронтенды на `npm run preview`.

3. Перед запуском скопируйте файлы `.env_template` из каждого сервиса в `.env` и укажите параметры подключения к БД и секретные ключи.

Пример для сервиса сообщений:
```env
DB_HOST1=pg1
DB_HOST2=pg2
DB_PORT1=5432
DB_PORT2=5433
DB_USER=db_user
DB_PASSWORD=db_password
DB_NAME=db_name
```

## Описание сервисов

### Auth
Сервис предоставляет REST API для регистрации пользователей, входа и проверки кода. Пример метода регистрации приведён в `auth/README.MD`:
```text
http://localhost:8000/register - POST
аргументы: username, password
```
Возвращает данные пользователя или ошибку, если логин занят.

### Messages
Отправляет email с кодом подтверждения и другие уведомления через SMTP. Для работы требуются параметры сервера SMTP в `.env`.

### Main
Основной сервис реализует WebSocket‑API и множество REST методов для работы с транзакциями, пользователями и генерации документов. Сервис использует модули из каталога `pages/` для подготовки данных по запросу клиента.

### Frontend
В каталоге `frontend` находятся два приложения на Node.js: `user` и `admin`. Запуск осуществляется командой `npm run preview` (используется скриптом `run_all.csh`). Для взаимодействия с бекендом используется WebSocket (см. `frontend/user/README.MD`).

## Дополнительные скрипты

- `update_service.csh` – запрашивает имя сервиса, выполняет `git pull` и перезапускает все Python‑процессы.
- `run_all.csh` – автоматический запуск всех микросервисов и фронтендов.

## Тестирование

В репозитории присутствуют экспериментальные скрипты `test*.py`, но полноценный тестовый набор отсутствует. При необходимости можно запустить `pytest`, однако тесты не будут найдены.

