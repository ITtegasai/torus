import{r as o,W as Q,b as Z,d as ee,j as e,e as se,B as f,I as j,M as P,s as te,f as v,i as ae,k as ne}from"./index-CxNXazyc.js";import{s as a,I as C,T as oe,u as ce}from"./ReactSlider-D3tcLCcN.js";import{T as ie}from"./Tabs-CMzsi51Z.js";import{I as le}from"./ImageLoader-DdenBJX_.js";import{u as re}from"./useWSSend-BU2iH3ii.js";import{q as de,r as ue}from"./qr_torus-uy8TiILN.js";import{q as me,r as xe}from"./qr_ecliptics-B3hpk3-U.js";import{L as he,J as fe,E as je}from"./loadFileAsBase64-DR4lHEua.js";import"./Pagination-C43MfAmQ.js";const pe=await he(fe),_e=["Ун.№ транзакции","Описание","Дата","Статус","Сумма, ₽","Действия"],B=[{title:"Создана",class:a.statusCreated},{title:"На проверке",class:a.statusChecking},{title:"Отклонена",class:a.statusRejected},{title:"Оплачена",class:a.statusPayed}];function ge(){const{transactions:n,isReady:I,user:D}=o.useContext(Q),p=o.useRef(""),_=o.useRef(null),g=o.useRef(null),R=o.useRef(null),[w,b]=o.useState(null),[A,r]=o.useState(!1),[h,W]=o.useState([]),[y,F]=o.useState({amount_min:0,amount_max:0}),S=[{link:null,title:"Список счетов"}];D?.lo>0&&S.push({link:"/finances/bonuses",title:"Бонусы"});const[z]=Z(["access_token"]),k=z?.access_token,J=()=>{b(null),R?.current?.clear(),p.current=null},V=s=>{p.current=s,_?.current?.open()},$=async()=>{try{r(!0);const s=new FormData;s.append("receipt",w),await te(k,p?.current,s),_?.current?.close(!1),v.success("Уже проверяем Вашу оплату"),J()}catch(s){console.log(s)}finally{r(!1)}},U=async s=>{try{r(!0),await ae(k,s),v.success("Успешно отменено")}catch(t){console.log(t)}finally{r(!1)}},[m,H]=o.useState({min:0,max:0}),M=re();o.useEffect(()=>{n&&(r(!1),H({min:n.min_amount,max:n.max_amount}))},[n]),o.useEffect(()=>{n&&F({amount_min:n.min_amount,amount_max:n.max_amount})},[n?.amount_max]),o.useEffect(()=>{n?.amount_max>0&&N(0)},[y]),ee("Finances",{tx_type:0,limit:10,offset:0,filter:""});const N=(s=0,t=y.amount_min,l=y.amount_max)=>{r(!0),M("Finances",{tx_type:0,limit:10,offset:s*10,filter:l?`amount >= ${t} and amount <= ${l}`:""})},O=()=>{g.current.close(),F(s=>({...s,amount_min:h[0],amount_max:h[1]})),N(0,h[0],h[1])},Y=async s=>{try{r(!0);const t=await ne(k,s),l=URL.createObjectURL(t),c=document.createElement("a");c.href=l,c.download=`dogovor_${s}.pdf`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(l)}catch(t){console.log(t),v.error("Не удалось скачать договор")}finally{r(!1)}},T=s=>{if(s!=="torus"&&s!=="ecliptics")return;const t=new je,l=t.internal.pageSize.height;t.addFileToVFS("Jost-400.ttf",pe),t.addFont("Jost-400.ttf","Jost","normal"),t.setFont("Jost","normal");const c=10;let d=10,i=c;const u=10,G=t.internal.pageSize.getWidth(),L=10,X=G-L*2,q=40,E=40,K=L+(X-q)/2;t.addImage(s==="torus"?de:me,"PNG",K,10,q,E),i+=E,s==="torus"&&ue.forEach(x=>{i>l-u&&(t.addPage(),i=c),i+=u,t.setFontSize(12),t.text(x.label,d,i),i+=u,t.setFontSize(14),t.text(x.text,d,i-3)}),s==="ecliptics"&&xe.forEach(x=>{i>l-u&&(t.addPage(),i=c),i+=u,t.setFontSize(12),t.text(x.label,d,i),i+=u,t.setFontSize(14),t.text(x.text,d,i-3)}),t.save(`requisite-${s}.pdf`)};return e.jsxs(e.Fragment,{children:[(I&&!n||A)&&e.jsx(se,{}),e.jsxs("div",{className:a.container,children:[e.jsxs("div",{className:a.header,children:[e.jsx(ie,{tabs:S}),e.jsxs("div",{className:a.buttons,children:[e.jsx(f,{onClick:()=>g?.current?.open(),type:"secondary",children:e.jsx(j,{name:"filter",width:21})}),e.jsx(f,{type:"secondary",children:e.jsx(j,{name:"download",width:21})})]})]}),e.jsx("div",{className:a.financesInfo,children:e.jsxs("div",{className:a.infoTabs,children:[e.jsx(C,{text:["Всего оплаченных счетов:",n?.amount_received]}),e.jsx(C,{text:["Счетов в ожидании:",n?.in_waiting]}),e.jsx(C,{text:["Отклоненные:",n?.rejected]})]})}),e.jsxs("div",{className:a.table,children:[e.jsxs("h4",{className:a.tableTitle,children:["Список счетов",e.jsxs("div",{style:{display:"flex",flexDirection:"row",gap:"10px"},children:[e.jsx("button",{onClick:()=>T("torus"),children:"Скачать реквизиты АО «Торус Групп»"}),e.jsx("button",{onClick:()=>T("ecliptics"),children:"Скачать реквизиты АО «Эклиптикс»"})]})]}),e.jsx(oe,{onChangePage:s=>N(s),count:n?.count||0,pagination:!0,totalData:n?.transactions||[],header:_e,rowItem:(s,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:s.tx_hash}),e.jsx("td",{children:n.buy_types[s.buy_type]}),e.jsx("td",{children:s.create_at}),e.jsx("td",{children:e.jsxs("p",{className:B[s.status].class,children:[e.jsx("span",{}),B[s.status].title]})}),e.jsx("td",{children:s.amount}),e.jsxs("td",{children:[s.status===0&&e.jsxs("div",{className:a.rowBtns,children:[e.jsxs("button",{className:a.actionBtn,onClick:()=>V(s.tx_hash),children:[e.jsx(j,{name:"paper-clip",width:20}),"Отправить"]}),e.jsx("button",{className:a.cancelBtn,onClick:()=>U(s.tx_hash),children:"Отменить"})]}),(s.status===1||s.status===3)&&e.jsxs("button",{onClick:()=>Y(s.tx_hash),className:a.actionBtn,children:[e.jsx(j,{name:"download",width:20}),"Скачать"]})]})]},t)})]})]}),e.jsx(P,{modalRef:_,children:e.jsxs("div",{className:a.modal,children:[e.jsx("h5",{className:a.modalTitle,children:"Прикрепите чек оплаты"}),e.jsxs("div",{className:a.modalContainer,children:[e.jsx("div",{className:a.modalImageLoader,children:e.jsx(le,{onClear:()=>b(null),loaderRef:R,setFile:b})}),e.jsx(f,{disabled:!w,onClick:$,type:"primary",children:"Подтвердить оплату"})]})]})}),e.jsx(P,{modalRef:g,position:"right",children:e.jsxs("div",{className:a.filterModalContainer,children:[e.jsx("h4",{className:a.filterModal__title,children:"Настройка фильтра"}),m.max&&e.jsx(ce,{className:a.slider,thumbClassName:a.slider__thumb,trackClassName:a.slider__track,defaultValue:[m.min,m.max],min:m.min,max:m.max,step:1,onChange:s=>W(s),renderThumb:(s,t)=>{const{key:l,...c}=s;return e.jsx("div",{...c,children:e.jsx("div",{className:a.slider__label,children:t.valueNow})},l)},renderTrack:(s,t)=>{const l=t.index,{key:c,...d}=s;return e.jsx("div",{...d,className:`${a.slider__track} ${l===1?a.slider__trackBetween:""}`},c)}}),e.jsx("div",{className:a.useFilterBtn,children:e.jsx(f,{onClick:O,children:"Применить"})})]})})]})}const Te=o.memo(ge);export{Te as default};
