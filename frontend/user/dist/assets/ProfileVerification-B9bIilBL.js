import{r as i,W as U,b as T,u as $,C as q,f as g,D as A,d as M,j as e,e as O,c as W,I as z,B as x,M as G}from"./index-CxNXazyc.js";import{T as H}from"./Tabs-CMzsi51Z.js";import{s as t}from"./Profile.module-BEE_HuUs.js";import{I as P}from"./ImageLoader-DdenBJX_.js";function C(a){const n=a.split(","),o=n[0].indexOf("base64")>=0?atob(n[1]):decodeURI(n[1]),r=n[0].split(":")[1].split(";")[0],d=new Uint8Array(o.length);for(let l=0;l<o.length;l++)d[l]=o.charCodeAt(l);return new Blob([d],{type:r})}const k=(a,n)=>{let o=!0;return n.forEach(r=>{if(!a[r]){o=!1;return}}),o},w=["first_name","username","birthday","passport_date","passport_number","registration","phone","telegram"],J=[{link:"/profile",title:"Личные данные"},{link:null,title:"Верификация"}],K=[{title:"Верификация в статусе обработки",icon:"reload",class:t.verificationStatusPending},{title:"Верификация успешно пройдена",icon:"file-done",class:t.verificationStatusDone},{title:"Верификация успешно пройдена",icon:"file-done",class:t.verificationStatusDone},{title:"Верификация успешно пройдена",icon:"file-done",class:t.verificationStatusDone}];function ee(){const{user:a}=i.useContext(U),[n,o]=i.useState(null),[r,d]=i.useState(null),[l,y]=i.useState(null),[j,D]=i.useState(null),[v,S]=i.useState(!1),[I,b]=i.useState(!1),[L,f]=i.useState(!1),[_]=T(["access_token"]),N=$(),u=i.useRef(null),c=_?.access_token;i.useEffect(()=>{if(a&&!k(a,w)){u.current.open();return}},[a]);const F=i.useCallback(async()=>{if(!a)throw new Error("Отсутствует соединение");if(!k(a,w)){g.error("Обязательные поля не заполнены"),N("/profile");return}try{b(!0);const s=new FormData;s.append("passport",r),s.append("selfie",n),await q(c,s),f(!1),g.success("Уже проверяем ваши данные")}catch(s){console.log(s.message),g.error("Ошибка",s.message||s)}finally{b(!1)}},[r,n,c]),V=i.useCallback(async()=>{try{S(!0);const s=await A(c);if(!s)return;D(`data:image/jpeg;base64,${s[0].filedata}`),d(C(`data:image/jpeg;base64,${s[0].filedata}`)),o(C(`data:image/jpeg;base64,${s[1].filedata}`)),y(`data:image/jpeg;base64,${s[1].filedata}`)}catch(s){return console.log(s),null}finally{S(!1)}},[c]);i.useEffect(()=>{c&&V()},[c]),M(null);const R=s=>{d(s),f(!0)},B=s=>{o(s),f(!0)},E=!n||!r||a?.role>0||!L,p=j&&l,m=a&&a.role>0&&p?1:p&&a&&a.role===0?0:null,h=K[m||0];return e.jsxs(e.Fragment,{children:[I&&e.jsx(O,{}),e.jsxs("div",{className:t.container,children:[e.jsxs("div",{className:t.headerVerification,children:[e.jsx(H,{tabs:J}),a&&p&&m!==null&&e.jsxs("div",{className:W(t.verificationStatus,h.class),children:[e.jsx("p",{children:h.title}),e.jsx(z,{width:24,name:h.icon})]})]}),e.jsxs("div",{className:t.verificationForm,children:[e.jsxs("div",{className:t.verificationFormStep,children:[e.jsx("h4",{className:t.verificationStepTitle,children:"Шаг 1"}),e.jsx("p",{className:t.verificationStepDescr,children:"Загрузка фотографии паспорта"}),e.jsx(P,{isLoading:v,imgUrl:j,setFile:R})]}),e.jsxs("div",{className:t.verificationFormStep,children:[e.jsx("h4",{className:t.verificationStepTitle,children:"Шаг 2"}),e.jsx("p",{className:t.verificationStepDescr,children:"Загрузка фотографии селфи с паспортом"}),e.jsx(P,{isLoading:v,imgUrl:l,setFile:B})]})]}),e.jsx("div",{className:t.endBtn,children:e.jsx(x,{onClick:F,disabled:E,children:"Пройти верификацию"})})]}),e.jsx(G,{modalRef:u,children:e.jsxs("div",{className:t.needVerification,children:[e.jsx("h5",{className:t.needVerification__title,children:"Заполните обязательные поля"}),e.jsx("p",{className:t.needVerification__descr,children:"Перед отправкой документов на верификацию, необходимо заполнить обязательные поля Профиля"}),e.jsx(x,{onClick:()=>N("/profile"),children:"Заполнить"}),e.jsx(x,{onClick:()=>u?.current?.close(),type:"outlined",children:"Отмена"})]})})]})}export{ee as default};
